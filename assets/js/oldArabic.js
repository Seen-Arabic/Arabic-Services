// BEGIN GLOBAL
ar = {
  Ø§: ["|", "1", "!", "×Ÿ", "×Ÿ", "×•", "â´¶"],
  Ø¨: ["Ù®", "Ù»", "Ù¾", "Ú€", "Ù¹", "Þž", "Þ", "Ý", "Ý’", "Ý•"],
  Øª: ["Ù®", "Ù¹", "Ùº", "Ù¼", "Ù½", "Ù¿", "Þ", "ÚŒ", "Ý“"],
  Ø«: ["Ù®", "Ù¹", "Ù½", "Ù¿", "Þ", "Þ"],
  Ø­: ["Ø­", "7"],
  Ø¬: ["Úƒ", "Ú„", "Ú†", "Ú‡", "Ý˜"],
  Ø®: ["Ø­", "Ú", "Ý—"],
  Ø¯: ["Úˆ", "Ú‰", "ÚŠ", "Ú", "Ý™", "Ýš", "×‘", "×›"],
  Ø°: ["Úˆ", "Ú", "Û®", "× "],
  Ø±: ["Ú“", "Ú•", "Ú–", "Ý›"],
  Ø²: ["Ú‘", "Ú™", "Ø±", "Ú˜", "Ú–", "Û¯", "Ý«", "Ý¬"],
  Ø³: ["Þ‚", "Úš", "Ýœ", "Ý­"],
  Ø´: ["Úš", "Ýœ", "Ý­", "×©×‚"],
  Øµ: ["ØµÙ€Þª"],
  Ø¶: ["Øµ", "Ø¶"],
  Ø·: ["Ø·"],
  Ø¸: ["Ø·", "Ø¸"],
  Ø¹: ["ÝŸ", "Ý"],
  Øº: ["Ú ", "Ý", "Ýž", "ÝŸ", "Ø¹"],
  Ù: ["Ú¡", "Ú¤", "Ú¦", "Ú¨", "Ý ", "Ý¡", "Ú¡Ù’"],
  Ù‚: ["Ù¯", "Ú¨"],
  Ùƒ: ["Ú¬", "Ú­", "Ú©", "Úª", "Ú«", "Ú¯", "Ú±", "Ú³", "Ý¤"],
  Ù„: ["Úµ", "Ýª"],
  Ù…: ["Ý¥", "Ý¦", "Þ˜", "ÞŒ", "×¡", "×"],
  Ù†: ["Úº", "Ú»", "Ú¼", "Ú½", "Ý”", "Ý–", "Ý§", "Ý¨", "Ý©"],
  Ù‡: ["Û€", "Û", "Û‚", "Ûƒ", "Û¿"],
  Ùˆ: ["Û…", "Û†", "Û‡", "Ûˆ", "Û", "Û‰", "Û‹"],
  ÙŠ: ["Û", "ÛŽ", "Û", "Û’", "ÛŒÛª"],
};

ar2 = {
  Ø§: [
    "Ã",
    "Ã‚",
    "Ã‚",
    "Ã„",
    "Ã¡",
    "Ã ",
    "Ã¥",
    "Ã£",
    "Ã¤",
    "Ã",
    "ÃŒ",
    "ÃŽ",
    "Ã",
    "Ã¯",
    "Ã¬",
    "Ã®",
    "Ã­",
    "Ð†",
    "i",
    "â´¶",
    "âµ‚",
    "âµ",
    "âµ¤",
    "×Ÿ",
    "×™",
    "×•",
    "Æ—",
    "Æ–",
    "Ç",
  ],
  Ø¨: ["ÃŸ", "Ã¾", "Î²", "Ñ¢"],
  Øª: ["á¿£"],
  Ø«: ["á¿£"],
  Ø­: ["âµ’", "×–", "7", "â±¿", "â±¬", "â±«"],
  Ø¬: ["âµ’"],
  Ø®: ["âµ’"],
  Ø¯: ["×›", "×‘", "× ", "×›"],
  Ø°: ["×›", "×‘", "× ", "×›"],
  Ø±: ["J"],
  Ø²: ["J"],
  Ø³: [
    "Ð¨",
    "Ð©",
    "Ñˆ",
    "Ñ‰\tÑ°",
    "×©",
    "á½ ",
    "á½¡",
    "á½¢",
    "á½£",
    "á½¤",
    "á½¥",
    "á½¦",
    "á½§",
    "á¿²",
    "á¿³",
    "á¿´",
    "á¿¶",
    "á¿·",
    "á¾¡",
    "á¾¢",
    "á¾£",
    "á¾¤",
    "á¾¥",
    "á¾¦",
    "á¾§",
    "á½½",
    "á½¼",
    "á¾ ",
    "É¯",
    "É°",
    "Ï¢",
    "Ï£",
    "Ïˆ",
    "Ï‰",
  ],
  Ø´: [
    "×©×‚",
    "á½¡",
    "á½¢",
    "á½£",
    "á½¤",
    "á½¥",
    "á½¦",
    "á½§",
    "á¿´",
    "á¿¶",
    "á¿·",
    "á¾¡",
    "á¾¢",
    "á¾£",
    "á¾¤",
    "á¾¥",
    "á¾¦",
    "á¾§",
    "á½½",
    "á½¼",
    "á¾ ",
    "Ï£",
  ],
  Øµ: [],
  Ø¶: [],
  Ø·: ["Ù€âµ Ù€Ø§Ù€"],
  Ø¸: [],
  Ø¹: ["Ð—", "3", "âµ‰", "âµŽ", "Î¾", "Ï‚", "Ê¢", "á¶“"],
  Øº: ["âµ‰", "âµŽ", "Î¾", "Ï‚", "Ê¢", "á¶“"],
  Ù: ["Ù€È¯Ù€", "âµ”", "o", "Ðž", "Ã’", "Ã”", "Ã“", "Ã²", "Ã´", "Ã³"],
  Ù‚: ["âµš", "Ã¶", "Ã–", "ê˜", "ê–"],
  Ùƒ: [],
  Ù„: ["J"],
  Ù…: [
    "Ã–",
    "Ã•",
    "Ã˜",
    "Ã’",
    "Ã”",
    "Ã“",
    "Ã²",
    "Ã´",
    "Ã³",
    "Ãµ",
    "Ã¶",
    "Ã¸",
    "o",
    "Ðž",
    "â´²",
    "âµ”",
    "âµ™",
    "âµš",
    "×¡",
    "×",
    "áµ’",
    "Ï",
    "Ïƒ",
    "Ê˜",
  ],
  Ù†: ["Ð˜", "Ð™", "Ð›", "ÐŸ", "Ð»", "Ð¹", "Ð¸", "Ð·", "âµ¡", "Å¯"],
  Ù‡: ["Ð¤", "Ñ„", "Ã°", "×˜", "âµ€", "â´²", "â±·", "ê‹", "êŠ", "êº", "Ï†", "á¶•", "á»¼", "á»½"],
  Ùˆ: ["ð¤", "ê¯", "ê®", "ê°"],
  ÙŠ: [],
};

alone_letters = ["Ø¯", "Ø°", "Ø±", "Ø²", "Ùˆ", "Ø§", "Ø£", "Ø¥", "Ø¡", "Ø¤", "Ø¢"];

alef = ["Ø£", "Ø¥", "Ø¢"];
yaa = ["Ù‰", "Ø¦"];
waw = ["Ø¤"];
standard_letters = [
  "Ø§",
  "Ø£",
  "Ø¢",
  "Ø¥",
  "Ø¨",
  "Øª",
  "Ø«",
  "Ø­",
  "Ø¬",
  "Ø®",
  "Ø¯",
  "Ø°",
  "Ø±",
  "Ø²",
  "Ø³",
  "Ø´",
  "Øµ",
  "Ø¶",
  "Ø·",
  "Ø¸",
  "Ø¹",
  "Øº",
  "Ù",
  "Ù‚",
  "Ùƒ",
  "Ù„",
  "Ù…",
  "Ù†",
  "Ù‡",
  "Ùˆ",
  "Ø¤",
  "ÙŠ",
  "Ù‰",
  "Ø¦",
];

const panned = [
  "ÙÙ„Ø³Ø·ÙŠÙ†",
  "Ø¹Ø±Ø¨",
  "Ù‡ÙˆØ¯",
  "ØµÙ‡ÙŠÙˆÙ†",
  "Ø³Ø±Ø§Ø¦ÙŠÙ„",
  "Ø¯ÙˆÙ„",
  "ÙƒÙŠØ§Ù†",
  "Ø­ØªÙ„",
  "Ù‡ØªÙ„Ø±",
  "Ø®Ù†Ø§Ø²ÙŠØ±",
  "Ø­ÙŠ",
  "Ø´ÙŠØ®",
  "Ø¬Ø±Ø§Ø­",
  "Ø³Ù‚Ø·",
  "Ù‚Ø¯Ø³",
  "Ù‚ØµÙ‰",
  "Ø·Ø¨Ø¹",
  "Ø®Ø§Ù†",
  "ÙƒØªØ§Ø¦Ø¨",
  "Ø¹Ø²",
  "Ø¯ÙŠÙ†",
  "Ù‚Ø³Ø§Ù…",
  "Ø¬Ù‡Ø§Ø¯",
  "Ø¬Ø§Ù‡Ø¯",
  "Ø³Ù„Ø§Ù…",
  "Ø®ÙˆØ§Ø±Ø²Ù…",
  "Ù„ÙˆØºØ§Ø±ÙŠØ²Ù…",
  "ÙƒØªØ§Ø¨",
  "Ø¨Ø¯ÙˆÙ†",
  "Ù†Ù‚Ø·",
  "Ù…Ø§Ø±Ùƒ",
  "Ù„Ø¹Ù†",
  "Ø­Ù‚ÙŠØ±",
  "Ù…ÙˆØª",
  "Ù‚Ø§ÙˆÙ…",
  "Ø²ÙˆØ±Ø¨ÙŠØ±",
  "Ø¹Ø§ØµÙ…",
  "Ø­Ø±",
  "Ø±Ù‡Ø§Ø¨",
  "Ù‚Ø±Ø¯",
  "Ø¯Ø¹Ù…",
  "ØºØ²",
  "Ù†Ù‚Ø°",
  "Ù†ØªÙ‡Ùƒ",
  "Ù…Ø¹Ø§ÙŠÙŠØ±",
  "ØµÙ„",
  "Ø¨Ø§Ù†",
  "Ø¯ÙˆÙ†",
  "Ø¬ÙŠØ´",
  "Ø¹Ø¯Ùˆ",
  "Ø­Ù…Ø§Ø³",
  "ÙƒØ±",
];
// =============================

addons_prefix = ["Ø£", "Ø§", "Ø¥", "Ø§Ù„", "ÙŠ", "Øª", "Ù†", "Ø¨"];
addons_suffix = ["Ø©", "Ù‡", "ÙŠ", "Ù‰", "ÙŠØ©", "ÙŠÙ†", "ÙˆÙ†", "Ù‡Ù…"];

letters = [
  "Ø§",
  "Ø£",
  "Ø¥",
  "Ø¢",
  "Ø¡",
  "Ø¨",
  "Ù¾",
  "Øª",
  "Ø«",
  "Ø¬",
  "Ú†",
  "Ø­",
  "Ø®",
  "Ø¯",
  "Ø°",
  "Ø±",
  "Ø²",
  "Ú˜",
  "Ø³",
  "Ø´",
  "Øµ",
  "Ø¶",
  "Ø·",
  "Ø¸",
  "Ø¹",
  "Øº",
  "Ù",
  "Ú¤",
  "Ù‚",
  "Ùƒ",
  "Ú¯",
  "Ù„",
  "Ù…",
  "Ù†",
  "Ù‡",
  "Ø©",
  "Ùˆ",
  "Ø¤",
  "ÙŠ",
  "Ù‰",
  "Ø¦",
];

FATHATAN = "\u064b";
DAMMATAN = "\u064c";
KASRATAN = "\u064d";
FATHA = "\u064e";
DAMMA = "\u064f";
KASRA = "\u0650";
SHADDA = "\u0651";
SUKUN = "\u0652";
TASHKEEL = [FATHATAN, DAMMATAN, KASRATAN, FATHA, DAMMA, KASRA, SUKUN, SHADDA];

let LETTERS_DICT = {
  Ø§: "Ø§",
  Ø£: "Ø§",
  Ø¥: "Ø§",
  Ø¢: "Ø§",
  Ø¡: "",
  Ø¨: "Ù®",
  Ù¾: "Ù®",
  Øª: "Ù®",
  Ø«: "Ù®",
  Ø¬: "Ø­",
  Ú†: "Ø­",
  Ø®: "Ø­",
  Ø­: "Ø­",
  Ø¯: "Ø¯",
  Ø°: "Ø¯",
  Ø±: "Ø±",
  Ø²: "Ø±",
  Ú˜: "Ø±",
  Ø³: "Ø³",
  Ø´: "Ø³",
  Øµ: "Øµ",
  Ø¶: "Øµ",
  Ø·: "Ø·",
  Ø¸: "Ø·",
  Ø¹: "Ø¹",
  Øº: "Ø¹",
  Ù: "Ú¡",
  Ú¤: "Ú¡",
  Ù‚: "Ù¯",
  Ùƒ: "Ú©",
  Ú¯: "Ú©",
  Ù„: "Ù„",
  Ù…: "Ù…",
  Ù†: "Úº",
  Ù‡: "Ù‡",
  Ùˆ: "Ùˆ",
  Ø¤: "Ùˆ",
  Ø©: "Ù‡",
  Ù‰: "Ù‰",
  ÙŠ: "Ù‰",
  Ø¦: "Ù‰",
};

/// END GLOBAL

/// ==================================================== \\\

/// BEGIN STRING MANIPULATION

// replace a character at string
function setCharAt(str, index, chr) {
  if (index > str.length - 1) return str;
  return str.substring(0, index) + chr + str.substring(index + 1);
}

function remove_addons(string) {
  if (addons_prefix.includes(string.substring(0, 2))) {
    //for  ALEF & LAM
    string = setCharAt(string, 0, "");
    string = setCharAt(string, 0, "");
  } else if (addons_prefix.includes(string.substring(0, 1))) {
    string = setCharAt(string, 0, "");
  }

  if (addons_suffix.includes(string.substring(string.length - 2))) {
    string = setCharAt(string, string.length - 1, "");
    string = setCharAt(string, string.length - 1, "");
  } else if (addons_suffix.includes(string[string.length - 1])) {
    string = setCharAt(string, string.length - 1, "");
  }
  return string;
}

/// END STRING MANIPULATION

/// ==================================================== \\\

/// BEGIN COMPARISON
function similarity(s1, s2) {
  var longer = s1;
  var shorter = s2;
  if (s1.length < s2.length) {
    longer = s2;
    shorter = s1;
  }
  var longerLength = longer.length;
  if (longerLength === 0) {
    return 1.0;
  }
  return (
    (longerLength - editDistance(longer, shorter)) / parseFloat(longerLength)
  );
}

function editDistance(s1, s2) {
  s1 = s1.toLowerCase();
  s2 = s2.toLowerCase();

  var costs = new Array();
  for (var i = 0; i <= s1.length; i++) {
    var lastValue = i;
    for (var j = 0; j <= s2.length; j++) {
      if (i == 0) costs[j] = j;
      else {
        if (j > 0) {
          var newValue = costs[j - 1];
          if (s1.charAt(i - 1) != s2.charAt(j - 1))
            newValue = Math.min(Math.min(newValue, lastValue), costs[j]) + 1;
          costs[j - 1] = lastValue;
          lastValue = newValue;
        }
      }
    }
    if (i > 0) costs[s2.length] = lastValue;
  }
  return costs[s2.length];
}

function panned_ratio(string) {
  index = 0;
  mx = -1;
  for (i in panned) {
    ratio = similarity(string, panned[i]);
    if (ratio > mx) {
      mx = ratio;
      index = i;
    }
  }
  return mx * 100;
}
/// END COMPARISON

/// ==================================================== \\\

/// BEGIN TASHFEER

function mapping(character) {
  if (alef.includes(character)) {
    character = "Ø§";
  }
  if (waw.includes(character)) {
    character = "Ùˆ";
  }
  if (yaa.includes(character)) {
    character = "ÙŠ";
  }
  alter_list = ar[character];
  rand = Math.floor(Math.random() * alter_list.length);
  alter = alter_list[rand];
  return alter;
}

function tashfeer(string, lvl = 0) {
  len = string.length;
  n = 0;
  if (len <= 4) {
    n = Math.min(1 + lvl, len);
  } else if (len < 8) {
    n = Math.min(2 + lvl, len);
  } else {
    n = Math.min(3 + lvl, len);
  }
  const random = new Set();
  while (random.size != n) {
    random.add(Math.floor(Math.random() * len));
  }
  numbers = Array.from(random);
  numbers.sort();
  str = "";
  for (i = 0; i < len; i++) {
    if (standard_letters.includes(string[i]) && numbers.includes(i)) {
      letter = mapping(string[i]);
      if (i != 0) {
        if (!alone_letters.includes(string[i - 1])) {
          str += "Ù€";
        }
      }
      str += letter;
    } else {
      str += string[i];
    }
  }
  return str;
}

/// END TASHFEER

/// ==================================================== \\\

/// FROM UI
function each_word(string, level = 0) {
  std_ratio = 70;
  switch (level) {
    case 0:
      return ArabicService.toOldArabic(string);
    case 1:
      str = "";
      for (let i of string.split(" ")) {
        add = panned_ratio(remove_addons(i)) >= std_ratio ? true : false;
        if (add) {
          str += tashfeer(i, level + (add ? 1 : 0)) + " ";
        } else {
          str += ArabicService.toOldArabic(i) + " ";
        }
      }
      return str;
    case 2:
      str = ArabicServices.tashfeer(string);
      for (let i of string.split(" ")) {
        level = 1;
        add = panned_ratio(remove_addons(i)) >= std_ratio ? true : false;
        str += tashfeer(i, level + (add ? 1 : 0)) + " ";
      }
      return str;
    default:
      level = 1;
      str = "";
      for (let i of string.split(" ")) {
        add = panned_ratio(remove_addons(i)) >= std_ratio ? true : false;
        if (add) {
          str += tashfeer(i, level + (add ? 1 : 0)) + " ";
        } else {
          str += i + " ";
        }
      }
      return str;
  }
}
modes = {
  "old-arabic": 0,
  "old-arabic+popular": 1,
  "encrypt-all": 2,
  "encrypt-popular": 3,
};

function convertText(mode) {
  let value = input_str.value;
  if (value != "") {
    output_str.value = each_word(input_str.value, modes[mode]);
    document.getElementById("saved").innerHTML = "";
    document.getElementById("out-box").className = "";
    document.getElementById("out-box").classList.add("out-box-show");
  } else {
    output_str.value = "";
  }
}

function copy_to_clipboard() {
  var copyText = document.getElementById("output_str");
  if (copyText.value == "") {
    return;
  }
  /* Select the text field */
  copyText.select();
  copyText.setSelectionRange(0, 99999); /* For mobile devices */

  /* Copy the text inside the text field */
  document.execCommand("copy");

  /* Alert the copied text */
  document.getElementById("saved").innerHTML = "ØªÙ… Ø§Ù„Ù†Ø³Ø®";
}

const oldArabicCheck = document.getElementById("oldArabicCheck");
const encryptCommonCheck = document.getElementById("encryptCommonCheck");
const encryptAllCheck = document.getElementById("encryptAllCheck");
encryptAllCheck.addEventListener("change", function () {
  if (this.checked) {
    oldArabicCheck.checked = false;
    encryptCommonCheck.checked = false;
  } else {
    oldArabicCheck.checked = true;
    encryptCommonCheck.checked = true;
  }
  saveSelection();
});

oldArabicCheck.addEventListener("change", function () {
  if (
    !this.checked &&
    !encryptCommonCheck.checked &&
    !encryptAllCheck.checked
  ) {
    oldArabicCheck.checked = true;
  } else {
    encryptAllCheck.checked = false;
  }
  saveSelection();
});

encryptCommonCheck.addEventListener("change", function () {
  if (!this.checked && !oldArabicCheck.checked && !encryptAllCheck.checked) {
    oldArabicCheck.checked = true;
  } else {
    encryptAllCheck.checked = false;
  }
  saveSelection();
});

function convert() {
  if (
    oldArabicCheck.checked &&
    !encryptCommonCheck.checked &&
    !encryptAllCheck.checked
  ) {
    convertText("old-arabic");
  } else if (
    oldArabicCheck.checked &&
    encryptCommonCheck.checked &&
    !encryptAllCheck.checked
  ) {
    convertText("old-arabic+popular");
  } else if (encryptAllCheck.checked) {
    convertText("encrypt-all");
  } else if (
    encryptCommonCheck.checked &&
    !encryptAllCheck.checked &&
    !oldArabicCheck.checked
  ) {
    convertText("encrypt-popular");
  }
}

/**
 * save selection to local storage
 */
function saveSelection() {
  let oldArabic = oldArabicCheck.checked;
  let encryptCommon = encryptCommonCheck.checked;
  let encryptAll = encryptAllCheck.checked;
  localStorage.setItem("oldArabic", oldArabic);
  localStorage.setItem("encryptCommon", encryptCommon);
  localStorage.setItem("encryptAll", encryptAll);
}

/**
 * get selection from local storage
 */
function getSelection() {
  const oldArabic = localStorage.getItem("oldArabic");
  const encryptCommon = localStorage.getItem("encryptCommon");
  const encryptAll = localStorage.getItem("encryptAll");

  oldArabicCheck.checked = oldArabic === "true";
  encryptCommonCheck.checked = encryptCommon === "true";
  encryptAllCheck.checked = encryptAll === "true";

  if (
    !oldArabicCheck.checked &&
    !encryptCommonCheck.checked &&
    !encryptAllCheck.checked
  ) {
    oldArabicCheck.checked = true;
  }
}

// execute on load
getSelection();
