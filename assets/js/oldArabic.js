// BEGIN GLOBAL
ar = {
  ا: ["|", "1", "!", "ן", "ן", "ו", "ⴶ"],
  ب: ["ٮ", "ٻ", "پ", "ڀ", "ٹ", "ޞ", "ސ", "ݐ", "ݒ", "ݕ"],
  ت: ["ٮ", "ٹ", "ٺ", "ټ", "ٽ", "ٿ", "ސ", "ڌ", "ݓ"],
  ث: ["ٮ", "ٹ", "ٽ", "ٿ", "ޝ", "ސ"],
  ح: ["ح", "7"],
  ج: ["ڃ", "ڄ", "چ", "ڇ", "ݘ"],
  خ: ["ح", "ځ", "ݗ"],
  د: ["ڈ", "ډ", "ڊ", "ڍ", "ݙ", "ݚ", "ב", "כ"],
  ذ: ["ڈ", "ڏ", "ۮ", "נ"],
  ر: ["ړ", "ڕ", "ږ", "ݛ"],
  ز: ["ڑ", "ڙ", "ر", "ژ", "ږ", "ۯ", "ݫ", "ݬ"],
  س: ["ނ", "ښ", "ݜ", "ݭ"],
  ش: ["ښ", "ݜ", "ݭ", "שׂ"],
  ص: ["صـު"],
  ض: ["ص", "ض"],
  ط: ["ط"],
  ظ: ["ط", "ظ"],
  ع: ["ݟ", "ݝ"],
  غ: ["ڠ", "ݝ", "ݞ", "ݟ", "ع"],
  ف: ["ڡ", "ڤ", "ڦ", "ڨ", "ݠ", "ݡ", "ڡْ"],
  ق: ["ٯ", "ڨ"],
  ك: ["ڬ", "ڭ", "ک", "ڪ", "ګ", "گ", "ڱ", "ڳ", "ݤ"],
  ل: ["ڵ", "ݪ"],
  م: ["ݥ", "ݦ", "ޘ", "ތ", "ס", "ם"],
  ن: ["ں", "ڻ", "ڼ", "ڽ", "ݔ", "ݖ", "ݧ", "ݨ", "ݩ"],
  ه: ["ۀ", "ہ", "ۂ", "ۃ", "ۿ"],
  و: ["ۅ", "ۆ", "ۇ", "ۈ", "ۏ", "ۉ", "ۋ"],
  ي: ["ۍ", "ێ", "ې", "ے", "ی۪"],
};

ar2 = {
  ا: [
    "Á",
    "Â",
    "Â",
    "Ä",
    "á",
    "à",
    "å",
    "ã",
    "ä",
    "Ï",
    "Ì",
    "Î",
    "Í",
    "ï",
    "ì",
    "î",
    "í",
    "І",
    "i",
    "ⴶ",
    "ⵂ",
    "ⵏ",
    "ⵤ",
    "ן",
    "י",
    "ו",
    "Ɨ",
    "Ɩ",
    "ǁ",
  ],
  ب: ["ß", "þ", "β", "Ѣ"],
  ت: ["ΰ"],
  ث: ["ΰ"],
  ح: ["ⵒ", "ז", "7", "Ɀ", "ⱬ", "Ⱬ"],
  ج: ["ⵒ"],
  خ: ["ⵒ"],
  د: ["כ", "ב", "נ", "כ"],
  ذ: ["כ", "ב", "נ", "כ"],
  ر: ["J"],
  ز: ["J"],
  س: [
    "Ш",
    "Щ",
    "ш",
    "щ\tѰ",
    "ש",
    "ὠ",
    "ὡ",
    "ὢ",
    "ὣ",
    "ὤ",
    "ὥ",
    "ὦ",
    "ὧ",
    "ῲ",
    "ῳ",
    "ῴ",
    "ῶ",
    "ῷ",
    "ᾡ",
    "ᾢ",
    "ᾣ",
    "ᾤ",
    "ᾥ",
    "ᾦ",
    "ᾧ",
    "ώ",
    "ὼ",
    "ᾠ",
    "ɯ",
    "ɰ",
    "Ϣ",
    "ϣ",
    "ψ",
    "ω",
  ],
  ش: [
    "שׂ",
    "ὡ",
    "ὢ",
    "ὣ",
    "ὤ",
    "ὥ",
    "ὦ",
    "ὧ",
    "ῴ",
    "ῶ",
    "ῷ",
    "ᾡ",
    "ᾢ",
    "ᾣ",
    "ᾤ",
    "ᾥ",
    "ᾦ",
    "ᾧ",
    "ώ",
    "ὼ",
    "ᾠ",
    "ϣ",
  ],
  ص: [],
  ض: [],
  ط: ["ـⵠـاـ"],
  ظ: [],
  ع: ["З", "3", "ⵉ", "ⵎ", "ξ", "ς", "ʢ", "ᶓ"],
  غ: ["ⵉ", "ⵎ", "ξ", "ς", "ʢ", "ᶓ"],
  ف: ["ـȯـ", "ⵔ", "o", "О", "Ò", "Ô", "Ó", "ò", "ô", "ó"],
  ق: ["ⵚ", "ö", "Ö", "Ꝙ", "Ꝗ"],
  ك: [],
  ل: ["J"],
  م: [
    "Ö",
    "Õ",
    "Ø",
    "Ò",
    "Ô",
    "Ó",
    "ò",
    "ô",
    "ó",
    "õ",
    "ö",
    "ø",
    "o",
    "О",
    "ⴲ",
    "ⵔ",
    "ⵙ",
    "ⵚ",
    "ס",
    "ם",
    "ᵒ",
    "ρ",
    "σ",
    "ʘ",
  ],
  ن: ["И", "Й", "Л", "П", "л", "й", "и", "з", "ⵡ", "ů"],
  ه: ["Ф", "ф", "ð", "ט", "ⵀ", "ⴲ", "ⱷ", "ꝋ", "Ꝋ", "ꝺ", "φ", "ᶕ", "Ỽ", "ỽ"],
  و: ["𐤁", "ꝯ", "Ꝯ", "ꝰ"],
  ي: [],
};

alone_letters = ["د", "ذ", "ر", "ز", "و", "ا", "أ", "إ", "ء", "ؤ", "آ"];

alef = ["أ", "إ", "آ"];
yaa = ["ى", "ئ"];
waw = ["ؤ"];
standard_letters = [
  "ا",
  "أ",
  "آ",
  "إ",
  "ب",
  "ت",
  "ث",
  "ح",
  "ج",
  "خ",
  "د",
  "ذ",
  "ر",
  "ز",
  "س",
  "ش",
  "ص",
  "ض",
  "ط",
  "ظ",
  "ع",
  "غ",
  "ف",
  "ق",
  "ك",
  "ل",
  "م",
  "ن",
  "ه",
  "و",
  "ؤ",
  "ي",
  "ى",
  "ئ",
];

/*
  Panned Words Are Encoded
  Delete this var and replace it with 
  const panned = ['panned_word1','panned_word2']
*/
// =============================
var _0x2434 = [
  "\u0641\u0644\u0633\u0637\u064A\u0646",
  "\u0639\u0631\u0628",
  "\u0647\u0648\u062F",
  "\u0635\u0647\u064A\u0648\u0646",
  "\u0633\u0631\u0627\u0626\u064A\u0644",
  "\u062F\u0648\u0644",
  "\u0643\u064A\u0627\u0646",
  "\u062D\u062A\u0644",
  "\u0647\u062A\u0644\u0631",
  "\u062E\u0646\u0627\u0632\u064A\u0631",
  "\u062D\u064A",
  "\u0634\u064A\u062E",
  "\u062C\u0631\u0627\u062D",
  "\u0633\u0642\u0637",
  "\u0642\u062F\u0633",
  "\u0642\u0635\u0649",
  "\u0637\u0628\u0639",
  "\u062E\u0627\u0646",
  "\u0643\u062A\u0627\u0626\u0628",
  "\u0639\u0632",
  "\u062F\u064A\u0646",
  "\u0642\u0633\u0627\u0645",
  "\u062C\u0647\u0627\u062F",
  "\u062C\u0627\u0647\u062F",
  "\u0633\u0644\u0627\u0645",
  "\u062E\u0648\u0627\u0631\u0632\u0645",
  "\u0644\u0648\u063A\u0627\u0631\u064A\u0632\u0645",
  "\u0643\u062A\u0627\u0628",
  "\u0628\u062F\u0648\u0646",
  "\u0646\u0642\u0637",
  "\u0645\u0627\u0631\u0643",
  "\u0644\u0639\u0646",
  "\u062D\u0642\u064A\u0631",
  "\u0645\u0648\u062A",
  "\u0642\u0627\u0648\u0645",
  "\u0632\u0648\u0631\u0628\u064A\u0631",
  "\u0639\u0627\u0635\u0645",
  "\u062D\u0631",
  "\u0631\u0647\u0627\u0628",
  "\u0642\u0631\u062F",
  "\u062F\u0639\u0645",
  "\u063A\u0632",
  "\u0646\u0642\u0630",
  "\u0646\u062A\u0647\u0643",
  "\u0645\u0639\u0627\u064A\u064A\u0631",
  "\u0635\u0644",
  "\u0628\u0627\u0646",
  "\u062F\u0648\u0646",
  "\u062C\u064A\u0634",
  "\u0639\u062F\u0648",
  "\u062D\u0645\u0627\u0633",
  "\u0643\u0631",
];
const panned = [
  _0x2434[0],
  _0x2434[1],
  _0x2434[2],
  _0x2434[3],
  _0x2434[4],
  _0x2434[5],
  _0x2434[6],
  _0x2434[7],
  _0x2434[8],
  _0x2434[9],
  _0x2434[10],
  _0x2434[11],
  _0x2434[12],
  _0x2434[13],
  _0x2434[14],
  _0x2434[15],
  _0x2434[16],
  _0x2434[17],
  _0x2434[18],
  _0x2434[19],
  _0x2434[20],
  _0x2434[21],
  _0x2434[22],
  _0x2434[23],
  _0x2434[24],
  _0x2434[25],
  _0x2434[26],
  _0x2434[27],
  _0x2434[28],
  _0x2434[29],
  _0x2434[30],
  _0x2434[31],
  _0x2434[32],
  _0x2434[33],
  _0x2434[34],
  _0x2434[35],
  _0x2434[36],
  _0x2434[37],
  _0x2434[38],
  _0x2434[39],
  _0x2434[40],
  _0x2434[41],
  _0x2434[42],
  _0x2434[43],
  _0x2434[44],
  _0x2434[45],
  _0x2434[46],
  _0x2434[29],
  _0x2434[47],
  _0x2434[48],
  _0x2434[49],
  _0x2434[50],
  _0x2434[51],
];
// =============================

addons_prefix = ["أ", "ا", "إ", "ال", "ي", "ت", "ن", "ب"];
addons_suffix = ["ة", "ه", "ي", "ى", "ية", "ين", "ون", "هم"];

letters = [
  "ا",
  "أ",
  "إ",
  "آ",
  "ء",
  "ب",
  "پ",
  "ت",
  "ث",
  "ج",
  "چ",
  "ح",
  "خ",
  "د",
  "ذ",
  "ر",
  "ز",
  "ژ",
  "س",
  "ش",
  "ص",
  "ض",
  "ط",
  "ظ",
  "ع",
  "غ",
  "ف",
  "ڤ",
  "ق",
  "ك",
  "گ",
  "ل",
  "م",
  "ن",
  "ه",
  "ة",
  "و",
  "ؤ",
  "ي",
  "ى",
  "ئ",
];

FATHATAN = "\u064b";
DAMMATAN = "\u064c";
KASRATAN = "\u064d";
FATHA = "\u064e";
DAMMA = "\u064f";
KASRA = "\u0650";
SHADDA = "\u0651";
SUKUN = "\u0652";
TASHKEEL = [FATHATAN, DAMMATAN, KASRATAN, FATHA, DAMMA, KASRA, SUKUN, SHADDA];

let LETTERS_DICT = {
  ا: "ا",
  أ: "ا",
  إ: "ا",
  آ: "ا",
  ء: "",
  ب: "ٮ",
  پ: "ٮ",
  ت: "ٮ",
  ث: "ٮ",
  ج: "ح",
  چ: "ح",
  خ: "ح",
  ح: "ح",
  د: "د",
  ذ: "د",
  ر: "ر",
  ز: "ر",
  ژ: "ر",
  س: "س",
  ش: "س",
  ص: "ص",
  ض: "ص",
  ط: "ط",
  ظ: "ط",
  ع: "ع",
  غ: "ع",
  ف: "ڡ",
  ڤ: "ڡ",
  ق: "ٯ",
  ك: "ک",
  گ: "ک",
  ل: "ل",
  م: "م",
  ن: "ں",
  ه: "ه",
  و: "و",
  ؤ: "و",
  ة: "ه",
  ى: "ى",
  ي: "ى",
  ئ: "ى",
};

/// END GLOBAL
/// BEGIN OLD ARABIC SCRIPT
function is_alpha(word) {
  flag = word.search(/^[\u0621-\u064A0-9 ]+$/) != -1;
  return flag;
}

function is_vocalized(word) {
  if (is_alpha(word)) {
    return false;
  }
  flag = false;
  for (char in word) {
    if (is_tashkeel(word[char])) {
      flag = true;
      break;
    }
  }
  return flag;
}

function is_tashkeel(archar) {
  return TASHKEEL.includes(archar);
}

function replaceAll(oldch, newch, text) {
  for (i in text) {
    if (text[i] == oldch) {
      text.replace(oldch, newch);
    }
  }
  return text;
}

function strip_tashkeel(text) {
  if (text == null) {
    return text;
  }
  for (char in TASHKEEL) {
    try {
      text = text.replaceAll(TASHKEEL[char], "");
    } catch (err) {
      text = replaceAll(TASHKEEL[char], "", text);
    }
  }
  return text;
}

function old_arabic_script(sentence) {
  sentence = strip_tashkeel(sentence);
  var new_sentence = "";
  sentence_len = sentence.length;
  for (letter = 0; letter < sentence_len; letter++) {
    if (!letters.includes(sentence[letter])) {
      new_sentence += sentence[letter];
    } else {
      new_sentence += LETTERS_DICT[sentence[letter]];
      if (sentence[letter] == "ن") {
        var next_letter = letter + 1;
        if (next_letter < sentence_len) {
          var temp = new_sentence.substring(0, new_sentence.length - 1);
          if (letters.includes(sentence[next_letter])) {
            temp += LETTERS_DICT["ب"];
            new_sentence = temp;
          }
        }
      }
    }
  }
  return strip_tashkeel(new_sentence);
}

/// END OLD ARABIC SCRIPT
/// ==================================================== \\\

/// BEGIN STRING MANIPULATION

// replace a character at string
function setCharAt(str, index, chr) {
  if (index > str.length - 1) return str;
  return str.substring(0, index) + chr + str.substring(index + 1);
}

function remove_addons(string) {
  if (addons_prefix.includes(string.substring(0, 2))) {
    //for  ALEF & LAM
    string = setCharAt(string, 0, "");
    string = setCharAt(string, 0, "");
  } else if (addons_prefix.includes(string.substring(0, 1))) {
    string = setCharAt(string, 0, "");
  }

  if (addons_suffix.includes(string.substring(string.length - 2))) {
    string = setCharAt(string, string.length - 1, "");
    string = setCharAt(string, string.length - 1, "");
  } else if (addons_suffix.includes(string[string.length - 1])) {
    string = setCharAt(string, string.length - 1, "");
  }
  return string;
}

/// END STRING MANIPULATION

/// ==================================================== \\\

/// BEGIN COMPARISON
function similarity(s1, s2) {
  var longer = s1;
  var shorter = s2;
  if (s1.length < s2.length) {
    longer = s2;
    shorter = s1;
  }
  var longerLength = longer.length;
  if (longerLength === 0) {
    return 1.0;
  }
  return (
    (longerLength - editDistance(longer, shorter)) / parseFloat(longerLength)
  );
}

function editDistance(s1, s2) {
  s1 = s1.toLowerCase();
  s2 = s2.toLowerCase();

  var costs = new Array();
  for (var i = 0; i <= s1.length; i++) {
    var lastValue = i;
    for (var j = 0; j <= s2.length; j++) {
      if (i == 0) costs[j] = j;
      else {
        if (j > 0) {
          var newValue = costs[j - 1];
          if (s1.charAt(i - 1) != s2.charAt(j - 1))
            newValue = Math.min(Math.min(newValue, lastValue), costs[j]) + 1;
          costs[j - 1] = lastValue;
          lastValue = newValue;
        }
      }
    }
    if (i > 0) costs[s2.length] = lastValue;
  }
  return costs[s2.length];
}
function panned_ratio(string) {
  index = 0;
  mx = -1;
  for (i in panned) {
    ratio = similarity(string, panned[i]);
    if (ratio > mx) {
      mx = ratio;
      index = i;
    }
  }
  return mx * 100;
}
/// END COMPARISON

/// ==================================================== \\\

/// BEGIN TASHFEER

function mapping(character) {
  if (alef.includes(character)) {
    character = "ا";
  }
  if (waw.includes(character)) {
    character = "و";
  }
  if (yaa.includes(character)) {
    character = "ي";
  }
  alter_list = ar[character];
  rand = Math.floor(Math.random() * alter_list.length);
  alter = alter_list[rand];
  return alter;
}

function tashfeer(string, lvl = 0) {
  len = string.length;
  n = 0;
  if (len <= 4) {
    n = Math.min(1 + lvl, len);
  } else if (len < 8) {
    n = Math.min(2 + lvl, len);
  } else {
    n = Math.min(3 + lvl, len);
  }
  const random = new Set();
  while (random.size != n) {
    random.add(Math.floor(Math.random() * len));
  }
  numbers = Array.from(random);
  numbers.sort();
  str = "";
  for (i = 0; i < len; i++) {
    if (standard_letters.includes(string[i]) && numbers.includes(i)) {
      letter = mapping(string[i]);
      if (i != 0) {
        if (!alone_letters.includes(string[i - 1])) {
          str += "ـ";
        }
      }
      str += letter;
    } else {
      str += string[i];
    }
  }
  return str;
}

/// END TASHFEER

/// ==================================================== \\\

/// FROM UI
function each_word(string, level = 0) {
  std_ratio = 70;
  if (level == 0) {
    return old_arabic_script(string);
  } else if (level == 1) {
    str = "";
    for (let i of string.split(" ")) {
      add = panned_ratio(remove_addons(i)) >= std_ratio ? true : false;
      if (add) {
        str += tashfeer(i, level + (add ? 1 : 0)) + " ";
      } else {
        str += old_arabic_script(i) + " ";
      }
    }
    return str;
  } else if (level == 2) {
    str = "";
    for (let i of string.split(" ")) {
      level = 1;
      add = panned_ratio(remove_addons(i)) >= std_ratio ? true : false;
      str += tashfeer(i, level + (add ? 1 : 0)) + " ";
    }
    return str;
  } else {
    level = 1;
    str = "";
    for (let i of string.split(" ")) {
      add = panned_ratio(remove_addons(i)) >= std_ratio ? true : false;
      if (add) {
        str += tashfeer(i, level + (add ? 1 : 0)) + " ";
      } else {
        str += i + " ";
      }
    }
    return str;
  }
}
modes = {
  "old-arabic": 0,
  "old-arabic+popular": 1,
  "encrypt-all": 2,
  "encrypt-popular": 3,
};

function convertText(mode) {
  let value = input_str.value;
  if (value != "") {
    output_str.value = each_word(input_str.value, modes[mode]);
    document.getElementById("saved").innerHTML = "";
    document.getElementById("out-box").className = "";
    document.getElementById("out-box").classList.add("out-box-show");
  } else {
    output_str.value = "";
  }
}

function copy_to_clipboard() {
  var copyText = document.getElementById("output_str");
  if (copyText.value == "") {
    return;
  }
  /* Select the text field */
  copyText.select();
  copyText.setSelectionRange(0, 99999); /* For mobile devices */

  /* Copy the text inside the text field */
  document.execCommand("copy");

  /* Alert the copied text */
  document.getElementById("saved").innerHTML = "تم النسخ";
}

const oldArabicCheck = document.getElementById("oldArabicCheck");
const encryptCommonCheck = document.getElementById("encryptCommonCheck");
const encryptAllCheck = document.getElementById("encryptAllCheck");
encryptAllCheck.addEventListener("change", function () {
  if (this.checked) {
    oldArabicCheck.checked = false;
    encryptCommonCheck.checked = false;
  } else {
    oldArabicCheck.checked = true;
    encryptCommonCheck.checked = true;
  }
  saveSelection();
});

oldArabicCheck.addEventListener("change", function () {
  if (
    !this.checked &&
    !encryptCommonCheck.checked &&
    !encryptAllCheck.checked
  ) {
    oldArabicCheck.checked = true;
  } else {
    encryptAllCheck.checked = false;
  }
  saveSelection();
});

encryptCommonCheck.addEventListener("change", function () {
  if (!this.checked && !oldArabicCheck.checked && !encryptAllCheck.checked) {
    oldArabicCheck.checked = true;
  } else {
    encryptAllCheck.checked = false;
  }
  saveSelection();
});

function convert() {
  if (
    oldArabicCheck.checked &&
    !encryptCommonCheck.checked &&
    !encryptAllCheck.checked
  ) {
    convertText("old-arabic");
  } else if (
    oldArabicCheck.checked &&
    encryptCommonCheck.checked &&
    !encryptAllCheck.checked
  ) {
    convertText("old-arabic+popular");
  } else if (encryptAllCheck.checked) {
    convertText("encrypt-all");
  } else if (
    encryptCommonCheck.checked &&
    !encryptAllCheck.checked &&
    !oldArabicCheck.checked
  ) {
    convertText("encrypt-popular");
  }
}

/**
 * save selection to local storage
 */
function saveSelection() {
  let oldArabic = oldArabicCheck.checked;
  let encryptCommon = encryptCommonCheck.checked;
  let encryptAll = encryptAllCheck.checked;
  localStorage.setItem("oldArabic", oldArabic);
  localStorage.setItem("encryptCommon", encryptCommon);
  localStorage.setItem("encryptAll", encryptAll);
}

/**
 * get selection from local storage
 */
function getSelection() {
  const oldArabic = localStorage.getItem("oldArabic");
  const encryptCommon = localStorage.getItem("encryptCommon");
  const encryptAll = localStorage.getItem("encryptAll");

  oldArabicCheck.checked = oldArabic === "true";
  encryptCommonCheck.checked = encryptCommon === "true";
  encryptAllCheck.checked = encryptAll === "true";

  if (
    !oldArabicCheck.checked &&
    !encryptCommonCheck.checked &&
    !encryptAllCheck.checked
  ) {
    oldArabicCheck.checked = true;
  }
}

// execute on load
getSelection();
